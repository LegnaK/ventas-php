/*!
 * This file is a part of Mibew Messenger.
 *
 * Copyright 2005-2014 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var Mibew={};!function(t){t.Objects={},t.Widget=function(t){this.requestedScripts={},this.handlers=[],this.handlersDependencies={},this.requestURL=t.requestURL,this.requestTimeout=t.requestTimeout,this.visitorCookieName=t.visitorCookieName,this.inviteStyle=t.inviteStyle,this.locale=t.locale,this.dataToSend={};var e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("type","text/css"),e.setAttribute("href",t.inviteStyle),document.getElementsByTagName("head")[0].appendChild(e)},t.Widget.prototype.makeRequest=function(){var e=t.Utils.readCookie(this.visitorCookieName);this.dataToSend.entry=escape(document.referrer),this.dataToSend.locale=this.locale,this.dataToSend.rnd=Math.random(),e!==!1?this.dataToSend.user_id=e:this.dataToSend.user_id&&delete this.dataToSend.user_id,this.doLoadScript(this.requestURL+"?"+this.getQuery(),"responseScript"),this.dataToSend={}},t.Widget.prototype.getQuery=function(){var t=[];for(var e in this.dataToSend)this.dataToSend.hasOwnProperty(e)&&t.push(e+"="+this.dataToSend[e]);return t.join("&")},t.Widget.prototype.sendToServer=function(t){for(var e in t)if(t.hasOwnProperty(e)){var i=t[e];("string"==typeof i||"number"==typeof i)&&("string"==typeof i&&(i=encodeURIComponent(i)),this.dataToSend[e]=i)}},t.Widget.prototype.onResponse=function(e){var i=e.load,n=e.handlers,o=e.data,r=e.dependencies,a=this;for(var s in i)i.hasOwnProperty(s)&&(s in this.requestedScripts||(this.requestedScripts[s]={},this.requestedScripts[s].url=i[s],this.requestedScripts[s].status="loading",this.loadScript(s)));for(var d in r)r.hasOwnProperty(d)&&(d in this.handlersDependencies||(this.handlersDependencies[d]=r[d]));for(var c=0;c<n.length;c++){var u=n[c];this.canRunHandler(u)?t.APIFunctions[u](o):u in this.handlers||(this.handlers[u]=function(){t.APIFunctions[u](o)})}this.cleanUpAfterRequest(),window.setTimeout(function(){a.makeRequest()},this.requestTimeout)},t.Widget.prototype.cleanUpAfterRequest=function(){document.getElementsByTagName("head")[0].removeChild(document.getElementById("responseScript"))},t.Widget.prototype.loadScript=function(t){var e=this,i=this.doLoadScript(this.requestedScripts[t].url,t);i.onload=function(){e.scriptReady(t)},i.onreadystatechange=function(){("complete"==this.readyState||"loaded"==this.readyState)&&e.scriptReady(t)}},t.Widget.prototype.doLoadScript=function(t,e){var i=document.createElement("script");return i.setAttribute("type","text/javascript"),i.setAttribute("src",t),i.setAttribute("id",e),document.getElementsByTagName("head")[0].appendChild(i),i},t.Widget.prototype.scriptReady=function(t){this.requestedScripts[t].status="ready";for(var e in this.handlers)this.handlers.hasOwnProperty(e)&&this.canRunHandler(e)&&(this.handlers[e](),delete this.handlers[e])},t.Widget.prototype.canRunHandler=function(t){for(var e=this.handlersDependencies[t],i=0;i<e.length;i++)if("ready"!=this.requestedScripts[e[i]].status)return!1;return!0},t.Widget.init=function(e){t.Objects.widget=new t.Widget(e),t.Objects.widget.makeRequest()},t.Utils={},t.Utils.createCookie=function(t,e){var i=/([^\.]+\.[^\.]+)$/.exec(document.location.hostname),n=i[1];document.cookie=""+t+"="+e+"; path=/; "+(n?"domain="+n+";":"")},t.Utils.readCookie=function(t){for(var e=document.cookie.split("; "),i=t+"=",n=!1,o=0;o<e.length;o++)if(-1!=e[o].indexOf(i)){n=e[o].substr(i.length);break}return n},t.Invitation={},t.Invitation.create=function(t){var e=t.operatorName,i=t.avatarUrl,n=t.threadUrl,o=t.acceptCaption,r='<div id="mibewinvitationpopup" style="display: none;">';r+='<div id="mibewinvitationclose"><a href="javascript:void(0);" onclick="Mibew.Invitation.reject();">&times;</a></div>',e&&(r+='<h1 onclick="Mibew.Invitation.accept();">'+e+"</h1>"),i&&(r+='<img id="mibewinvitationavatar" src="'+i+'" title="'+e+'" alt="'+e+'" onclick="Mibew.Invitation.accept();" />'),n&&(r+='<iframe id="mibewinvitationframe" src="'+n+'" onload="Mibew.Invitation.show();" frameBorder="0"></iframe>'),o&&(r+='<div id="mibewinvitationaccept" onclick="Mibew.Invitation.accept();">'+o+"</div>"),r+='<div style="clear: both;"></div></div>';var a=document.getElementById("mibewinvitation");a&&(a.innerHTML=r)},t.Invitation.show=function(){var e=document.getElementById("mibewinvitationpopup");e&&(t.Invitation.trigger("show"),e.style.display="block")},t.Invitation.hide=function(){var e=document.getElementById("mibewinvitationpopup");e&&(t.Invitation.trigger("hide"),e.parentNode.removeChild(e))},t.Invitation.accept=function(){document.getElementById("mibewAgentButton")&&(t.Invitation.trigger("accept"),document.getElementById("mibewAgentButton").onclick(),t.Invitation.hide())},t.Invitation.reject=function(){t.Invitation.trigger("reject"),t.Objects.widget.sendToServer({invitation_rejected:1}),t.Invitation.hide()};var e={};t.Invitation.on=function(t,i){"string"==typeof t&&"function"==typeof i&&(e.hasOwnProperty(t)||(e[t]=[]),e[t].push(i))},t.Invitation.trigger=function(t,i){if("undefined"==typeof i&&(i={}),e.hasOwnProperty(t))for(var n=e[t],o=0,r=n.length;r>o;o++)n[o](i)},t.APIFunctions={},t.APIFunctions.updateUserId=function(e){t.Utils.createCookie(t.Objects.widget.visitorCookieName,e.user.id)},t.APIFunctions.invitationCreate=function(e){t.Invitation.create(e.invitation)},t.APIFunctions.invitationClose=function(){t.Invitation.hide()}}(Mibew);